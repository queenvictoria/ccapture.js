(function(){function s(a){return a&&a.Object===Object?a:null}function k(a){return("0000000"+a).slice(-7)}function I(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function c(a){var N={};this.settings=a;this.on=function(a,c){N[a]=c};this.emit=function(a){var c=N[a];c&&c.apply(null,Array.prototype.slice.call(arguments,1))};this.filename=a.name||I();this.mimeType=this.extension=""}function e(a){c.call(this,a);
this.extension=".tar";this.mimeType="application/x-tar";this.fileExtension="";this.tape=null;this.count=0}function J(a){e.call(this,a);this.type="image/png";this.fileExtension=".png"}function K(a){e.call(this,a);this.type="image/jpeg";this.fileExtension=".jpg";this.quality=a.quality/100||0.8}function y(a){"image/webp"!==document.createElement("canvas").toDataURL("image/webp").substr(5,10)&&console.log("WebP not supported - try another export format");c.call(this,a);a.quality=a.quality/100||0.8;this.extension=
".webm";this.mimeType="video/webm";this.baseFilename=this.filename;this.frames=[];this.part=1}function z(a){c.call(this,a);a.quality=a.quality/100||0.8;this.encoder=new FFMpegServer.Video(a);this.encoder.on("process",function(){this.emit("process")}.bind(this));this.encoder.on("finished",function(a,c){var e=this.callback;e&&(this.callback=void 0,e(a,c))}.bind(this));this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("error",
function(a){alert(JSON.stringify(a,null,2))}.bind(this))}function E(a){c.call(this,a);this.framerate=this.settings.framerate;this.type="image/png";this.fileExtension=this.extension=".png";this.mediaRecorder=this.stream=null;this.chunks=[];this.count=0;a.quality=a.quality/100||0.8;this.encoder=new WebSocket("ws://localhost:8889/")}function F(a){c.call(this,a);this.framerate=this.settings.framerate;this.type="video/webm";this.extension=".webm";this.mediaRecorder=this.stream=null;this.chunks=[]}function G(a){c.call(this,
a);a.quality=31-(30*a.quality/100||10);a.workers=a.workers||4;this.extension=".gif";this.mimeType="image/gif";this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.sizeSet=!1;this.encoder=new GIF({workers:a.workers,quality:a.quality,workerScript:a.workersPath+"gif.worker.js"});this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("finished",function(a){var c=this.callback;c&&(this.callback=void 0,
c(a))}.bind(this))}function h(a){function c(){function a(){this._hooked||(this._hooked=!0,this._hookedTime=this.currentTime||0,this.pause(),O.push(this));return this._hookedTime+b.startTime}p("Capturer start");k=window.Date.now();l=k+b.startTime;w=window.performance.now();H=w+b.startTime;window.Date.prototype.getTime=function(){return l};window.Date.now=function(){return l};window.setTimeout=function(a,o){var b={callback:a,time:o,triggerTime:l+o};q.push(b);p("Timeout set to "+b.time);return b};window.clearTimeout=
function(a){for(var o=0;o<q.length;o++)q[o]==a&&(q.splice(o,1),p("Timeout cleared"))};window.setInterval=function(a,o){var b={callback:a,time:o,triggerTime:l+o};t.push(b);p("Interval set to "+b.time);return b};window.clearInterval=function(){p("clear Interval");return null};window.requestAnimationFrame=function(a){x.push(a)};window.performance.now=function(){return H};Object.defineProperty(HTMLVideoElement.prototype,"currentTime",{get:a});Object.defineProperty(HTMLAudioElement.prototype,"currentTime",
{get:a})}function e(){L=!1;i.stop();p("Capturer stop");window.setTimeout=B;window.setInterval=I;window.clearTimeout=M;window.requestAnimationFrame=S;window.Date.prototype.getTime=T;window.Date.now=U;window.performance.now=V}function g(){B(P,0,void 0)}function h(){var a=m/b.framerate;if(b.frameLimit&&m>=b.frameLimit||b.timeLimit&&a>=b.timeLimit)e(),r();var d=new Date(null);d.setSeconds(a);n.textContent=2<b.motionBlurFrames?"CCapture "+b.format+" | "+m+" frames ("+u+" inter) | "+d.toISOString().substr(11,
8):"CCapture "+b.format+" | "+m+" frames | "+d.toISOString().substr(11,8)}function P(){var a=(m+u/b.motionBlurFrames)*(1E3/b.framerate);l=k+a;H=w+a;O.forEach(function(b){b._hookedTime=a/1E3});h();p("Frame: "+m+" "+u);for(var d=0;d<q.length;d++)l>=q[d].triggerTime&&(B(q[d].callback,0,void 0),q.splice(d,1));for(d=0;d<t.length;d++)l>=t[d].triggerTime&&(B(t[d].callback,0,void 0),t[d].triggerTime+=t[d].time);x.forEach(function(a){B(a,0,l-W)});x=[]}function r(a){a||(a=function(a){download(a,i.filename+
i.extension,i.mimeType);return!1});i.save(a)}function p(a){s&&console.log(a)}function v(a){var b=D[a];b&&b.apply(null,Array.prototype.slice.call(arguments,1))}var b=a||{},s,l,k,H,w,i,q=[],t=[],m=0,u=0,x=[],L=!1,D={};b.framerate=b.framerate||60;b.motionBlurFrames=2*(b.motionBlurFrames||1);s=b.verbose||!1;b.step=1E3/b.framerate;b.timeLimit=b.timeLimit||0;b.frameLimit=b.frameLimit||0;b.startTime=b.startTime||0;var n=document.createElement("div");n.style.position="absolute";n.style.left=n.style.top=0;
n.style.backgroundColor="black";n.style.fontFamily="monospace";n.style.fontSize="11px";n.style.padding="5px";n.style.color="red";n.style.zIndex=1E5;b.display&&document.body.appendChild(n);var j=document.createElement("canvas"),C=j.getContext("2d"),f,A;p("Step is set to "+b.step+"ms");var a={gif:G,webm:y,ffmpegserver:z,websocketserver:E,png:J,jpg:K,"webm-mediarecorder":F},Q=a[b.format];if(!Q)throw"Error: Incorrect or missing format: Valid formats are "+Object.keys(a).join(", ");i=new Q(b);i.step=g;
i.on("process",P);i.on("progress",function(a){v("progress",a)});!1=="performance"in window&&(window.performance={});Date.now=Date.now||function(){return(new Date).getTime()};if(!1=="now"in window.performance){var R=Date.now();performance.timing&&performance.timing.navigationStart&&(R=performance.timing.navigationStart);window.performance.now=function(){return Date.now()-R}}var B=window.setTimeout,I=window.setInterval,M=window.clearTimeout,S=window.requestAnimationFrame,U=window.Date.now,V=window.performance.now,
T=window.Date.prototype.getTime,O=[];return{start:function(){c();i.start();L=!0},capture:function(a){if(L)if(2<b.motionBlurFrames){if(j.width!==a.width||j.height!==a.height)j.width=a.width,j.height=a.height,f=new Uint16Array(4*j.height*j.width),C.fillStyle="#0",C.fillRect(0,0,j.width,j.height);C.drawImage(a,0,0);A=C.getImageData(0,0,j.width,j.height);for(a=0;a<f.length;a+=4)f[a]+=A.data[a],f[a+1]+=A.data[a+1],f[a+2]+=A.data[a+2];u++;if(u>=0.5*b.motionBlurFrames){for(var a=A.data,d=0;d<f.length;d+=
4)a[d]=2*f[d]/b.motionBlurFrames,a[d+1]=2*f[d+1]/b.motionBlurFrames,a[d+2]=2*f[d+2]/b.motionBlurFrames;C.putImageData(A,0,0);i.add(j);m++;u=0;p("Full MB Frame! "+m+" "+l);for(d=0;d<f.length;d+=4)f[d]=0,f[d+1]=0,f[d+2]=0;gc()}else g()}else i.add(a),m++,p("Full Frame! "+m)},stop:e,save:r,on:function(a,b){D[a]=b},getTiming:function(){return{framecount:m,intermediateframecount:u,time:l,performancetime:H}}}}var g={"function":!0,object:!0},r=g[typeof exports]&&exports&&!exports.nodeType?exports:void 0,
v=g[typeof module]&&module&&!module.nodeType?module:void 0,M=v&&v.exports===r?r:void 0,w=s(r&&v&&"object"==typeof global&&global),D=s(g[typeof self]&&self),x=s(g[typeof window]&&window),g=s(g[typeof this]&&this),w=w||x!==(g&&g.window)&&x||D||g||Function("return this")();"gc"in window||(window.gc=function(){});HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(a,c,e){for(var e=atob(this.toDataURL(c,e).split(",")[1]),g=e.length,k=new Uint8Array(g),
h=0;h<g;h++)k[h]=e.charCodeAt(h);a(new Blob([k],{type:c||"image/png"}))}});(function(){!1=="performance"in window&&(window.performance={});Date.now=Date.now||function(){return(new Date).getTime()};if(!1=="now"in window.performance){var a=Date.now();performance.timing&&performance.timing.navigationStart&&(a=performance.timing.navigationStart);window.performance.now=function(){return Date.now()-a}}})();var W=window.Date.now();c.prototype.start=function(){};c.prototype.stop=function(){};c.prototype.add=
function(){};c.prototype.save=function(){};c.prototype.dispose=function(){};c.prototype.safeToProceed=function(){return!0};c.prototype.step=function(){console.log("Step not set!")};e.prototype=Object.create(c.prototype);e.prototype.start=function(){this.dispose()};e.prototype.add=function(a){var c=new FileReader;c.onload=function(){this.tape.append(k(this.count)+this.fileExtension,new Uint8Array(c.result));this.count++;this.step()}.bind(this);c.readAsArrayBuffer(a)};e.prototype.save=function(a){a(this.tape.save())};
e.prototype.dispose=function(){this.tape=new Tar;this.count=0};J.prototype=Object.create(e.prototype);J.prototype.add=function(a){a.toBlob(function(a){e.prototype.add.call(this,a)}.bind(this),this.type)};K.prototype=Object.create(e.prototype);K.prototype.add=function(a){a.toBlob(function(a){e.prototype.add.call(this,a)}.bind(this),this.type,this.quality)};y.prototype=Object.create(c.prototype);y.prototype.start=function(){this.dispose()};y.prototype.add=function(a){this.frames.push(a.toDataURL("image/webp",
this.quality));0<this.settings.autoSaveTime&&this.frames.length/this.settings.framerate>=this.settings.autoSaveTime?this.save(function(a){this.filename=this.baseFilename+"-part-"+k(this.part);download(a,this.filename+this.extension,this.mimeType);this.dispose();this.part++;this.filename=this.baseFilename+"-part-"+k(this.part);this.step()}.bind(this)):this.step()};y.prototype.save=function(a){if(this.frames.length){var c=Whammy.fromImageArray(this.frames,this.settings.framerate),c=new Blob([c],{type:"octet/stream"});
a(c)}};y.prototype.dispose=function(){this.frames=[]};z.prototype=Object.create(c.prototype);z.prototype.start=function(){this.encoder.start(this.settings)};z.prototype.add=function(a){this.encoder.add(a)};z.prototype.save=function(a){this.callback=a;this.encoder.end()};z.prototype.safeToProceed=function(){return this.encoder.safeToProceed()};E.prototype=Object.create(c.prototype);E.prototype.add=function(a){a.toBlob(function(a){var c=new FileReader;c.onload=function(){frame=new Uint8Array(c.result);
filename=k(this.count)+this.fileExtension;this.encoder.send(frame);this.count++;this.step()}.bind(this);c.readAsArrayBuffer(a)}.bind(this),this.type)};E.prototype.save=function(){this.mediaRecorder.stop();this.encoder.close();this.stop()};F.prototype=Object.create(c.prototype);F.prototype.add=function(a){this.stream||(this.stream=a.captureStream(this.framerate),this.mediaRecorder=new MediaRecorder(this.stream),this.mediaRecorder.start(),this.mediaRecorder.ondataavailable=function(a){this.chunks.push(a.data)}.bind(this));
this.step()};F.prototype.save=function(a){this.mediaRecorder.onstop=function(){var c=new Blob(this.chunks,{type:"video/webm"});this.chunks=[];a(c)}.bind(this);this.mediaRecorder.stop()};G.prototype=Object.create(c.prototype);G.prototype.add=function(a){this.sizeSet||(this.encoder.setOption("width",a.width),this.encoder.setOption("height",a.height),this.sizeSet=!0);this.canvas.width=a.width;this.canvas.height=a.height;this.ctx.drawImage(a,0,0);this.encoder.addFrame(this.ctx,{copy:!0,delay:this.settings.step});
this.step()};G.prototype.save=function(a){this.callback=a;this.encoder.render()};(x||D||{}).CCapture=h;"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return h}):r&&v?(M&&((v.exports=h).CCapture=h),r.CCapture=h):w.CCapture=h})();
